---
{"dg-publish":true,"permalink":"/mysql/mysql/"}
---


# 什么是索引

索引是一种支持快速查找的数据结构，索引类似于查字典的时候的目录，本职工作是帮助我们快速查找数据。索引的底层通常用B+树或者哈希来实现

索引的优点
- 索引可以大大的加快我们的查询效率
- 创造唯一性索引可以保证每一行数据的唯一性
缺点
- 创建索引和维护索引需要耗费很多时间；进行crud的时候，如果数据有索引，索引也需要动态修改，降低SQL执行效率
- 索引需要存储空间
- 如果数据量不大，使用索引不能带来很大提升

# 索引分类

- 按数据结构分：B+树索引，哈1希索引
- 按物理存储分：聚簇索引（主键索引），二级索引（辅助索引）
- 按字段特性分：主键索引、唯一索引、普通索引、前缀索引
- 按字段个数分：普通索引、联合索引

- 唯一索引：索引的值必须为宜
- 联合索引：多个列组成一个索引
- 聚簇索引：聚簇索引是一种数据存储方式，具体细节取决于不同的实现

# 为什么innodb索引默认结构使用B+树，而不是B树，红黑树、哈希表，二叉树？

首先是B树和B+树
- B+树读写磁盘的代价更低：B+树的内部节点不包含具体的数据，只包含索引信息，因此B+树的内部节点比B树更小；在相同的内部节点条件下，B+树所需要的数据页面数量更小，磁盘块所能容纳的数据也更多了，IO次数也降低了
- B+树有大量的冗余节点，插入删除的时候效率更高，不会出现B树那种复杂的分裂合并
- B+树的数据全部存储在叶子节点，叶子节点使用链表组织，方便进行范围查找；而B树的分支节点也包含数据，B树的数据分布更为分散，范围查找效率低

红黑和B+树
- 红黑树高度的递增速度比B+树更快，而高度越高，IO次数越多，这是很致命的
- 红黑树的范围查找效率低

# 聚簇索引和非聚簇索引

- 聚簇索引指的是B+树中，叶子节点存放的是实际的数据
- 非聚簇索引（二级索引）指的是B+树中，叶子节点存储的是索引

innodb 为每个表创建一个聚簇索引，并且只会创建一个聚簇索引
- 如果有主键，则主键作为聚簇索引
- 如果没有主键，则使用第一个不包含NULL值的列作为聚簇索引
- 否则使用一个隐式自增id
## 回表与索引覆盖

对于innodb而言，如果我们查询的数据使用了二级索引，而又不是查询主键值，那么就要用查找到的主键值去聚簇索引B+树中进行查找。这个过程被称为 **回表**

但是如果索引包含我们所要的查询所有数据，那么我们就不需要根据主键回到聚簇索引进行查询，只需要一次磁盘IO就可以完成查询，这叫做 **索引覆盖**

# 联合索引

多个字段组成成一个索引，就被称为联合索引

联合索引必须有序才能匹配，也就是说查询的时候必须按照建立索引时的顺序挨个使用，否则索引失效

## 最左前缀匹配

联合索引的建立遵循最左优先，也就是说，只有联合索引的第一个列（索引列）是全局有序的，而其他列则是在索引列有序的情况下相对有序的。在查询时，根据索引列进行等值查询（二分查找），然后再按照其他列严格有序

因为这样，如果不按照最左匹配原则进行查询，则索引会失效。具体来说，查询的时候必须带上前缀索引才能命中索引，比如索引（a，b，c），以下情况可以匹配

- where a = 1 and b = 2 and c = 3
- where a = 1 and b = 2

以下情况不能匹配
- where a = 1 and c = 3
- where b = 2

## 范围查找

当遇到开区间范围查找的时候，范围查找的字段可以使用联合索引而范围查找后面的字段无法使用；对于闭区间范围查找，则不会停止匹配

- where a > 1 and b = 2,a使用了联合索引而b没有
- where a >= 1 and b =2, 会从符合a=1，b=2的第一条记录开始扫描，而不是a=1的第一条记录

## 索引下推优化

MySql5.6后，引入了索引下推优化，可以在联合索引遍历过程中，对联合索引包含的字段先做判断，直接过滤不符合条件的记录，减少回表次数



# 前缀索引

前缀索引是针对字符串类型建立的索引。顾名思义，前缀索引将多个字符串的公共部分取出来作为前缀索引，这样可以减少字符串类型的索引数目，提升查找效率

# 什么时候需要/不需要索引

索引不是万能的
- 需要占用物理空间
- 需要动态维护B+树降低crud的效率

什么时候需要索引
- 唯一字段可以使用唯一索引
- 经常被用于 `where，group by，order by` 的字段

什么时候不需要索引
- 数据量太少
- 经常更新的字段不需要索引：需要很多时间维护索引
- 字段中存在大量重复数据，比如性别字段
- 不被 `where group by order by` 使用的字段

# 索引失效

什么情况会导致索引失效
- 最左模糊匹配或者左右模糊匹配，比如 `like %xx`
- 使用 `!=,<>`进行查询
- 对索引使用函数
- 对索引使用表达式计算
- 对索引使用隐式类型转换
- 联合索引非最左匹配
- WHERE语句中，OR后面的列不是索引列而前面的列是索引列，就会导致索引失效

# 索引优化思路

- 防止索引失效
	- 左模糊匹配或左右模糊匹配
	- 计算，函数，类型转换
	- 最左匹配
	- OR
- 主键索引最好自增
	- 自增主键每次增加记录都是追加操作，不需要移动数据
- 索引列最好设置为 `NOT NULL`
	- 存在 `NULL` 值会导致优化器的优化操作更耗时
	- NULL会占用物理空间
- 覆盖索引优化
	- 使用联合索引
- 前缀索引优化